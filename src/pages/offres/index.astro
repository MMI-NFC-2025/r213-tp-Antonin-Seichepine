---
import Layout from "../../layouts/Layout.astro";
import Offrecard from "../../components/Offrecard.astro";
import { getOffres } from "../../backend.mjs";

const offres = await getOffres();
---

<Layout titre="Offres">
    <h1 class="text-xl font-semibold">Offres</h1>

    <div class="mt-4 flex flex-wrap items-center gap-3">
        <button
            id="favori-button"
            class="rounded-lg bg-indigo-800 px-4 py-2 font-semibold text-white"
            type="button"
        >
            Afficher les favoris
        </button>

        <button
            id="surface50-button"
            class="rounded-lg bg-indigo-800 px-4 py-2 font-semibold text-white"
            type="button"
        >
            + de 50 m²
        </button>

        <button
            id="prix100k-button"
            class="rounded-lg bg-indigo-800 px-4 py-2 font-semibold text-white"
            type="button"
        >
            - de 100 000 €
        </button>
    </div>

    <div id="offres-rail" class="mt-6 flex gap-6 overflow-x-auto pb-4">
        {
            offres.map((offre) => (
                <div
                    class="offre w-96 flex-shrink-0"
                    data-favori={offre.favori?.toString() ?? "false"}
                    data-surface={offre.surface?.toString() ?? "0"}
                    data-prix={offre.prix?.toString() ?? "0"}
                >
                    <Offrecard offre={offre} />
                </div>
            ))
        }
    </div>
</Layout>

<script>
    const wrappers = document.querySelectorAll(".offre");

    const favoriBtn = document.getElementById("favori-button");
    const surfaceBtn = document.getElementById("surface50-button");
    const prixBtn = document.getElementById("prix100k-button");

    let showOnlyFavorites = false;
    let showSurface50 = false;
    let showPrix100k = false;

    function applyFilters() {
        wrappers.forEach((wrap) => {
            const isFavori = wrap.dataset.favori === "true";
            const surface = Number(wrap.dataset.surface || "0");
            const prix = Number(wrap.dataset.prix || "0");

            const okFavori = showOnlyFavorites ? isFavori : true;
            const okSurface = showSurface50 ? surface > 50 : true;
            const okPrix = showPrix100k ? prix < 100000 : true;

            wrap.style.display =
                okFavori && okSurface && okPrix ? "block" : "none";
        });
    }

    favoriBtn?.addEventListener("click", () => {
        showOnlyFavorites = !showOnlyFavorites;
        favoriBtn.textContent = showOnlyFavorites
            ? "Afficher tout"
            : "Afficher les favoris";
        applyFilters();
    });

    surfaceBtn?.addEventListener("click", () => {
        showSurface50 = !showSurface50;
        surfaceBtn.textContent = showSurface50 ? "Afficher tout" : "+ de 50 m²";
        applyFilters();
    });

    prixBtn?.addEventListener("click", () => {
        showPrix100k = !showPrix100k;
        prixBtn.textContent = showPrix100k ? "Afficher tout" : "- de 100 000 €";
        applyFilters();
    });

    const cards = document.querySelectorAll(".offre-card");

    cards.forEach((card) => {
        const toggle = card.querySelector(".favori-toggle");
        if (!toggle) return;

        toggle.addEventListener("click", (e) => {
            e.stopPropagation();

            const isFavori = card.dataset.favori === "true";
            card.dataset.favori = isFavori ? "false" : "true";

            card.classList.toggle("bg-indigo-100");
            card.classList.toggle("bg-gray-100");

            toggle.textContent = isFavori ? "Standard" : "Favori";
            toggle.classList.toggle("bg-indigo-800");
            toggle.classList.toggle("text-white");
            toggle.classList.toggle("bg-slate-200");
            toggle.classList.toggle("text-indigo-950");

            const wrapper = card.closest(".offre");
            if (wrapper) wrapper.dataset.favori = card.dataset.favori;

            applyFilters();
        });
    });
</script>
