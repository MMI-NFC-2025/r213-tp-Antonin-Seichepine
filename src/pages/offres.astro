---
import Layout from "../layouts/Layout.astro";
import Offrecard from "../components/Offrecard.astro";
import { getOffres } from "../backend.mjs";

const offres = await getOffres();
---

<Layout titre="Offres">
    <h1 class="text-xl font-semibold">Offres</h1>

    <div class="mt-4 flex flex-wrap items-center gap-3">
        <button
            id="favori-button"
            class="rounded-lg bg-indigo-800 px-4 py-2 font-semibold text-white"
        >
            Afficher les favoris
        </button>

        <div class="flex items-center gap-2">
            <button
                id="prev"
                type="button"
                class="rounded-lg bg-slate-200 px-3 py-2 font-semibold text-indigo-950"
            >
                ←
            </button>
            <button
                id="next"
                type="button"
                class="rounded-lg bg-slate-200 px-3 py-2 font-semibold text-indigo-950"
            >
                →
            </button>
        </div>
    </div>

    <div id="offres-rail" class="mt-6 flex gap-6 overflow-x-auto pb-4">
        {
            offres.map((offre) => (
                <div
                    class="offre w-96 flex-shrink-0"
                    data-favori={offre.favori.toString()}
                >
                    <Offrecard offre={offre} />
                </div>
            ))
        }
    </div>
</Layout>

<script>
    const rail = document.getElementById("offres-rail");
    const prev = document.getElementById("prev");
    const next = document.getElementById("next");

    const button = document.getElementById("favori-button");
    let showOnlyFavorites = false;

    // Scroll d'une card (w-96 = 384px) + gap-6 (24px) => 408
    const step = 408;

    prev?.addEventListener("click", () => {
        rail?.scrollBy({ left: -step, behavior: "smooth" });
    });

    next?.addEventListener("click", () => {
        rail?.scrollBy({ left: step, behavior: "smooth" });
    });

    button?.addEventListener("click", () => {
        showOnlyFavorites = !showOnlyFavorites;
        const offres = document.querySelectorAll(".offre");

        offres.forEach((offre) => {
            const isFavori = offre.dataset.favori === "true";

            if (showOnlyFavorites) {
                offre.style.display = isFavori ? "block" : "none";
                button.textContent = "Afficher tout";
            } else {
                offre.style.display = "block";
                button.textContent = "Afficher les favoris";
            }
        });
    });

    const cards = document.querySelectorAll(".offre-card");

    cards.forEach((card) => {
        const toggle = card.querySelector(".favori-toggle");
        if (!toggle) return;

        toggle.addEventListener("click", (e) => {
            e.stopPropagation();

            const isFavori = card.dataset.favori === "true";
            card.dataset.favori = isFavori ? "false" : "true";

            card.classList.toggle("bg-indigo-100");
            card.classList.toggle("bg-gray-100");

            toggle.textContent = isFavori ? "Standard" : "Favori";
            toggle.classList.toggle("bg-indigo-800");
            toggle.classList.toggle("text-white");
            toggle.classList.toggle("bg-slate-200");
            toggle.classList.toggle("text-indigo-950");

            const wrapper = card.closest(".offre");
            if (wrapper) wrapper.dataset.favori = card.dataset.favori;

            if (showOnlyFavorites && wrapper) {
                wrapper.style.display =
                    card.dataset.favori === "true" ? "block" : "none";
            }
        });
    });
</script>
